name: Build Android APK (Final Magic)

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      # استخدام جافا 11 (المتوافقة تماماً مع أندرويد 11)
      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      # نود 16 هو الأفضل لهذه النسخ القديمة المستقرة
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '16'

      - name: Install Cordova
        run: npm install -g cordova

      # الخطوة السحرية: تجاهل كل أخطاء الماضي وبناء مشروع جديد نظيف
      - name: Create Project & Build
        run: |
          # 1. إنشاء مشروع جديد في مجلد مؤقت
          echo "Creating fresh project..."
          cordova create temp_app com.ehab.moazen "المؤذن"
          cd temp_app
          
          # 2. إضافة أندرويد 11 (النسخة الذهبية المستقرة التي تقبل كل الإضافات)
          echo "Adding Android Platform..."
          cordova platform add android@11.0.0
          
          # 3. تثبيت الإضافات من المتجر الرسمي (NPM) فقط
          # تجنبنا استخدام https://github... لمنع أخطاء Username/Password
          echo "Installing Plugins from NPM..."
          cordova plugin add cordova-plugin-device
          cordova plugin add cordova-plugin-dialogs
          cordova plugin add cordova-plugin-geolocation
          cordova plugin add cordova-plugin-android-permissions
          
          # تثبيت إضافة الإشعارات الرسمية (ستعمل لأننا عدنا لأندرويد 11)
          cordova plugin add cordova-plugin-local-notification
          
          # 4. تنظيف المجلد الجديد
          rm -rf www/*
          
          # 5. نقل ملفاتك أنت إلى المشروع الجديد
          echo "Copying your files..."
          cd ..
          
          # ننسخ كل شيء داخل www إذا كان موجوداً
          if [ -d "www" ]; then
             cp -r www/* temp_app/www/
          else
             # نسخ الملفات الفردية في حال لم تكن داخل مجلد www
             cp index.html temp_app/www/ 2>/dev/null || true
             cp style.css temp_app/www/ 2>/dev/null || true
             cp script.js temp_app/www/ 2>/dev/null || true
             cp adhan.mp3 temp_app/www/ 2>/dev/null || true
             cp sw.js temp_app/www/ 2>/dev/null || true
             cp manifest.json temp_app/www/ 2>/dev/null || true
             # نسخ أي مجلدات صور وصوت
             [ -d "images" ] && cp -r images temp_app/www/ || true
             [ -d "audio" ] && cp -r audio temp_app/www/ || true
          fi
          
          # 6. البناء النهائي
          cd temp_app
          echo "Building APK..."
          cordova build android --debug --device

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Moazen-App
          # لاحظ المسار الجديد
          path: temp_app/platforms/android/app/build/outputs/apk/debug/app-debug.apk
