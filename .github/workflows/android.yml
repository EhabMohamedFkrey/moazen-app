name: Build Android APK (Final Magic)

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      # استخدام جافا 11 (الأفضل لأندرويد 11)
      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '16'

      - name: Install Cordova
        run: npm install -g cordova

      # إنشاء المشروع من الصفر وتجاهل ملفات الإعدادات القديمة تماماً
      - name: Create Project & Build
        run: |
          # 1. إنشاء مشروع جديد
          echo "Creating fresh project..."
          cordova create temp_app com.ehab.moazen "المؤذن"
          cd temp_app
          
          # 2. إضافة أندرويد 11 (المستقر والمتسامح مع الأخطاء)
          echo "Adding Android Platform..."
          cordova platform add android@11.0.0
          
          # 3. تثبيت الإضافات من المتجر الرسمي (NPM) لضمان عدم وجود روابط مكسورة
          echo "Installing Plugins from NPM..."
          cordova plugin add cordova-plugin-device
          cordova plugin add cordova-plugin-dialogs
          cordova plugin add cordova-plugin-geolocation
          cordova plugin add cordova-plugin-android-permissions
          
          # تثبيت إضافة الإشعارات الرسمية (ستعمل بنجاح لأننا نستخدم أندرويد 11)
          cordova plugin add cordova-plugin-local-notification
          
          # 4. حذف الملفات الافتراضية للمشروع الجديد
          rm -rf www/*
          
          # 5. نسخ ملفاتك أنت إلى داخل المشروع الجديد
          echo "Copying your files..."
          cd ..
          
          # التحقق من مكان ملفاتك ونسخها
          if [ -d "www" ] && [ "$(ls -A www)" ]; then
             cp -r www/* temp_app/www/
          else
             # في حال كانت الملفات في الجذر مباشرة
             cp index.html temp_app/www/ 2>/dev/null || true
             cp style.css temp_app/www/ 2>/dev/null || true
             cp script.js temp_app/www/ 2>/dev/null || true
             cp adhan.mp3 temp_app/www/ 2>/dev/null || true
             cp sw.js temp_app/www/ 2>/dev/null || true
             cp manifest.json temp_app/www/ 2>/dev/null || true
             
             # نسخ مجلد الصور إذا وجد
             [ -d "images" ] && cp -r images temp_app/www/ || true
             [ -d "img" ] && cp -r img temp_app/www/ || true
             [ -d "audio" ] && cp -r audio temp_app/www/ || true
          fi
          
          # 6. العودة للمجلد وبناء التطبيق
          cd temp_app
          
          echo "Building APK..."
          cordova build android --debug --device

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Moazen-App
          path: temp_app/platforms/android/app/build/outputs/apk/debug/app-debug.apk
